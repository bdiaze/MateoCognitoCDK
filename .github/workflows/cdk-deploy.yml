name: CDK Deploy on AWS

on:
    push:
        branches:
            - main
      
jobs:
    build:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            id-token: write
        defaults:
            shell: bash
            working-directory: ${{ vars.DIRECTORIO_CDK }}
        env:
            URL_CALLBACK: ${{ vars.URL_CALLBACK }}
            URL_LOGOUT: ${{ vars.URL_LOGOUT }}
            VERIFICATION_BODY: ${{ vars.VERIFICATION_BODY }}
            VERIFICATION_SUBJECT: ${{ vars.VERIFICATION_SUBJECT }}
        steps:
            - name: Checkout Repositorio
              uses: actions/checkout@v4
      
            - name: Instalar .NET
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: ${{ vars.VERSION_DOTNET }}
      
            - name: Instalar Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ vars.VERSION_NODEJS }}
                  
            - name: Instalar AWS CDK
              run: npm install -g aws-cdk
      
            - name: Configure AWS Credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-region: ${{ vars.REGION_AWS }}
                  role-to-assume: ${{ vars.ARN_GITHUB_ROLE }}
                  
            - name: CDK Synth
              run: cdk synth
              
            - name: CDK Deploy
              run: cdk deploy --require-approval never
          